name: Deploy to AWS EC2

on:
  push:
    branches:
      - main

env:
  EC2_HOST: 54.175.157.12

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Build with Gradle
        run: |
          chmod +x ./gradlew
          ./gradlew clean build -x test

      - name: Rename JAR
        run: |
          cd build/libs
          JAR_FILE=$(ls *.jar | head -n 1)
          cp "$JAR_FILE" ../../revenda.jar
          cd ../..
          ls -lh revenda.jar

      - name: Copy JAR to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "revenda.jar"
          target: "/opt/revenda/"
          timeout: 60s
          command_timeout: 30s

      - name: Deploy application on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 90s
          command_timeout: 60s
          script: |
            set -x
            
            echo "=== Verificando Java ==="
            java -version || (sudo yum install -y java-21-amazon-corretto-headless && java -version)
            
            echo ""
            echo "=== Parando aplicação anterior ==="
            (pkill -9 -f "revenda.jar" && echo "Processo anterior parado") || echo "Nenhum processo para parar"
            sleep 3
            
            echo ""
            echo "=== Liberando porta 8080 ==="
            (sudo lsof -ti:8080 | xargs sudo kill -9 && echo "Porta liberada") || echo "Porta já livre"
            sleep 2
            
            echo ""
            echo "=== Configurando diretório ==="
            sudo mkdir -p /opt/revenda
            sudo chown -R ec2-user:ec2-user /opt/revenda
            cd /opt/revenda
            ls -la
            
            echo ""
            echo "=== Limpando logs antigos ==="
            rm -f app.log app.pid
            
            echo ""
            echo "=== Iniciando aplicação ==="
            nohup java -jar revenda.jar > app.log 2>&1 &
            APP_PID=$!
            echo "PID da aplicação: $APP_PID"
            echo $APP_PID > app.pid
            
            echo ""
            echo "=== Aguardando inicialização (20s) ==="
            for i in {1..20}; do
              echo -n "."
              sleep 1
            done
            echo ""
            
            echo ""
            echo "=== Verificando processo ==="
            if ps -p $APP_PID > /dev/null 2>&1; then
              echo "✓ Processo está rodando (PID: $APP_PID)"
            else
              echo "✗ Processo NÃO está rodando!"
              echo ""
              echo "=== Logs ==="
              cat app.log || echo "Sem logs disponíveis"
              exit 1
            fi
            
            echo ""
            echo "=== Verificando porta 8080 ==="
            if ss -tuln | grep :8080; then
              echo "✓ Porta 8080 está aberta e ouvindo"
            else
              echo "⚠ Porta 8080 ainda não abriu (pode estar inicializando)"
            fi
            
            echo ""
            echo "=== Últimas 50 linhas do log ==="
            tail -n 50 app.log
            
            echo ""
            echo "=== Deploy concluído com sucesso! ==="

      - name: Health Check
        run: |
          echo "Aguardando API inicializar..."
          sleep 30
          
          MAX_ATTEMPTS=10
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Tentativa $ATTEMPT de $MAX_ATTEMPTS..."
            
            if curl -f http://${{ env.EC2_HOST }}:8080/actuator/health; then
              echo "API está saudável!"
              exit 0
            fi
            
            echo "API ainda não está respondendo, aguardando..."
            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          echo "API não respondeu após $MAX_ATTEMPTS tentativas"
          exit 1
