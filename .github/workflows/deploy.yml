name: Deploy to AWS EC2

on:
  push:
    branches:
      - main

env:
  EC2_HOST: 54.221.12.217

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Build with Gradle
        run: |
          chmod +x ./gradlew
          ./gradlew clean build -x test

      - name: Rename JAR
        run: |
          cd build/libs
          # Pegar o JAR executável (sem -plain no nome)
          JAR_FILE=$(ls *.jar | grep -v plain | head -n 1)
          echo "JAR selecionado: $JAR_FILE"
          cp "$JAR_FILE" ../../revenda.jar
          cd ../..
          ls -lh revenda.jar

      - name: Copy JAR to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "revenda.jar"
          target: "/opt/revenda/"
          timeout: 60s
          command_timeout: 30s

      - name: Deploy application on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 90s
          command_timeout: 60s
          script: |
            # Script simples para iniciar a aplicação sem causar falhas no step
            set -x

            echo "=== Verificando/instalando Java ==="
            if ! command -v java >/dev/null 2>&1; then
              sudo yum install -y java-21-amazon-corretto-headless || true
            fi
            java -version || true

            echo "=== Garantindo diretório /opt/revenda ==="
            sudo mkdir -p /opt/revenda
            sudo chown -R ec2-user:ec2-user /opt/revenda
            cd /opt/revenda

            echo "=== Parando aplicação existente ==="
            EXISTING_PID=$(pgrep -f "revenda.jar" || true)
            if [ -n "$EXISTING_PID" ]; then
              echo "Matando processo existente: $EXISTING_PID"
              kill $EXISTING_PID || true
              sleep 3
              # Força se ainda estiver rodando
              kill -9 $EXISTING_PID 2>/dev/null || true
              echo "Processo anterior finalizado"
            else
              echo "Nenhum processo anterior encontrado"
            fi

            echo "=== Limpando log antigo ==="
            rm -f app.log || true

            echo "=== Iniciando aplicação ==="
            ls -lah /opt/revenda || true
            if [ ! -f /opt/revenda/revenda.jar ]; then
              echo "ERRO: /opt/revenda/revenda.jar não encontrado" && exit 1
            fi
            nohup java -jar revenda.jar --server.port=8080 > app.log 2>&1 &
            NEW_PID=$!
            echo "Nova aplicação iniciada com PID: $NEW_PID"

            echo "=== Concluído (step não falha aqui) ==="
            exit 0

      - name: Check Application Logs
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "=== Aguardando 15 segundos para app iniciar ==="
            sleep 15
            
            echo ""
            echo "=== Conteúdo de /opt/revenda ==="
            ls -lah /opt/revenda
            
            echo ""
            echo "=== Processos Java rodando ==="
            ps aux | grep java || echo "Nenhum processo Java encontrado"
            
            echo ""
            echo "=== Portas abertas ==="
            ss -tuln | grep :8080 || echo "Porta 8080 não está aberta"
            
            echo ""
            echo "=== Últimas 100 linhas do app.log ==="
            tail -n 100 /opt/revenda/app.log || echo "Arquivo app.log não existe"

      - name: Health Check
        run: |
          echo "Aguardando API inicializar..."
          sleep 30
          
          MAX_ATTEMPTS=10
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Tentativa $ATTEMPT de $MAX_ATTEMPTS..."
            
            if curl -f http://${{ env.EC2_HOST }}:8080/actuator/health; then
              echo "API está saudável!"
              exit 0
            fi
            
            echo "API ainda não está respondendo, aguardando..."
            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          echo "API não respondeu após $MAX_ATTEMPTS tentativas"
          exit 1
