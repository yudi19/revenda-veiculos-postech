name: Deploy to AWS EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: ./infra
        run: terraform init

      - name: Terraform Apply
        working-directory: ./infra
        run: terraform apply -auto-approve

      - name: Get EC2 IP
        id: ec2ip
        working-directory: ./infra
        run: |
          EC2_IP=$(terraform output -raw instance_public_ip)
          echo "ip=$EC2_IP" >> $GITHUB_OUTPUT
          echo "EC2 IP: $EC2_IP"

      - name: Wait for EC2 to be ready
        run: |
          echo "Aguardando EC2 ficar pronta..."
          sleep 60

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Build with Gradle
        run: |
          chmod +x ./gradlew
          ./gradlew clean build -x test

      - name: Rename JAR
        run: |
          cd build/libs
          JAR_FILE=$(ls *.jar | head -n 1)
          cp "$JAR_FILE" ../../revenda.jar
          cd ../..
          ls -lh revenda.jar

      - name: Copy JAR to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ steps.ec2ip.outputs.ip }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "revenda.jar"
          target: "/opt/revenda/"
          timeout: 60s
          command_timeout: 30s

      - name: Deploy application on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.ec2ip.outputs.ip }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 90s
          command_timeout: 60s
          script: |
            #!/bin/bash
            
            # Verificar se Java está instalado
            if ! command -v java &> /dev/null; then
              echo "Instalando Java 21..."
              sudo yum install -y java-21-amazon-corretto-headless
            fi
            
            # Verificar versão do Java
            echo "Java version:"
            java -version
            
            # Matar processo anterior se existir
            echo "Parando aplicação anterior..."
            pkill -9 -f "revenda.jar" 2>/dev/null || true
            sleep 3
            
            # Limpar processos na porta 8080
            echo "Liberando porta 8080..."
            sudo lsof -ti:8080 | xargs sudo kill -9 2>/dev/null || true
            sleep 2
            
            # Garantir que o diretório existe
            sudo mkdir -p /opt/revenda
            
            # Garantir permissões corretas
            sudo chown -R ec2-user:ec2-user /opt/revenda
            sudo chmod 755 /opt/revenda
            sudo chmod 644 /opt/revenda/revenda.jar 2>/dev/null || true
            
            # Ir para o diretório
            cd /opt/revenda
            
            # Limpar log anterior
            rm -f app.log
            touch app.log
            
            # Iniciar nova aplicação em background
            echo "Iniciando aplicação..."
            nohup java -jar revenda.jar > app.log 2>&1 &
            
            # Iniciar nova aplicação em background
            echo "Iniciando aplicação..."
            nohup java -jar revenda.jar > app.log 2>&1 &
            
            # Pegar o PID
            APP_PID=$!
            echo "Aplicação iniciada com PID: $APP_PID"
            
            # Salvar PID em arquivo
            echo $APP_PID > /opt/revenda/app.pid
            
            # Aguardar inicialização
            echo "Aguardando 15 segundos para inicialização..."
            sleep 15
            
            # Verificar se o processo ainda está rodando
            if ps -p $APP_PID > /dev/null 2>&1; then
              echo "✓ Aplicação está rodando (PID: $APP_PID)"
              echo ""
              echo "=== Logs recentes ==="
              tail -n 50 app.log
            else
              echo "✗ ERRO: Aplicação parou de rodar!"
              echo ""
              echo "=== Logs completos ==="
              cat app.log
              exit 1
            fi
            
            # Verificar se a porta 8080 está ouvindo
            echo ""
            echo "Verificando porta 8080..."
            if netstat -tuln | grep :8080 > /dev/null 2>&1; then
              echo "✓ Porta 8080 está aberta"
            else
              echo "⚠ Porta 8080 ainda não está aberta (pode estar inicializando)"
            fi

      - name: Health Check
        run: |
          echo "Aguardando API inicializar..."
          sleep 30
          
          MAX_ATTEMPTS=10
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Tentativa $ATTEMPT de $MAX_ATTEMPTS..."
            
            if curl -f http://${{ steps.ec2ip.outputs.ip }}:8080/actuator/health; then
              echo "API está saudável!"
              exit 0
            fi
            
            echo "API ainda não está respondendo, aguardando..."
            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          echo "API não respondeu após $MAX_ATTEMPTS tentativas"
          exit 1
